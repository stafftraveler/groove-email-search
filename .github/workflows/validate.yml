name: Validate Scripts

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check bash scripts syntax
      run: |
        bash -n setup.sh
        bash -n fetch_all_groove_emails.sh

    - name: Check for hardcoded tokens
      run: |
        # Search for AUTH_TOKEN= but exclude:
        # 1. Lines in echo/console.error statements (documentation)
        # 2. Lines containing placeholder text like "your_token_here"
        # 3. Lines in heredocs (cat > file << 'EOF')

        # Find potential violations
        violations=$(grep -r "AUTH_TOKEN=" --include="*.sh" --include="*.js" . | \
          grep -v "\.env\.example" | \
          grep -v "\.md:" | \
          grep -v "test-validation.sh" | \
          grep -v "echo" | \
          grep -v "console.error" | \
          grep -v "your_token_here" | \
          grep -v "your_groove_api_token_here" | \
          grep -v "AUTH_TOKEN=your" | \
          grep -v "# " || true)

        if [ ! -z "$violations" ]; then
          echo "Error: Found potentially hardcoded AUTH_TOKEN in code:"
          echo "$violations"
          exit 1
        fi
        echo "✓ No hardcoded tokens found"

    - name: Verify .gitignore includes .env
      run: |
        if ! grep -q "^\.env$" .gitignore; then
          echo "Error: .env not in .gitignore"
          exit 1
        fi
        echo "✓ .env is properly ignored"

    - name: Check required files exist
      run: |
        files=("setup.sh" "fetch_all_groove_emails.sh" ".env.example" ".gitignore" "README.md")
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file is missing"
            exit 1
          fi
        done
        echo "✓ All required files present"
